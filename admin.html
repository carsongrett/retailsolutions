<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Retail Solutions</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="logo-container">
            <i class="fas fa-building"></i>
            <h1>Retail Solutions</h1>
        </div>
    </header>
    <nav>
        <div class="nav-container">
            <a href="index.html"><i class="fas fa-home"></i> Home</a>
            <a href="form.html"><i class="fas fa-handshake"></i> Get Matched with a Broker</a>
            <a href="faq.html"><i class="fas fa-question-circle"></i> FAQ</a>
            <a href="admin.html"><i class="fas fa-user-shield"></i> Admin</a>
        </div>
    </nav>
    <button class="cta-button" id="joinBrokerBtn"><i class="fas fa-user-tie"></i> Brokers â€“ Join Here</button>
    <main>
        <section class="form-container" id="loginSection">
            <h2>Admin Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="adminEmail">Email</label>
                    <input type="email" id="adminEmail" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit" class="cta-button">Login</button>
            </form>
            <div id="loginMessage" style="margin-top:1rem;"></div>
        </section>
        <section class="form-container" id="dashboardSection" style="display:none;">
            <button id="logoutBtn" class="cta-button" style="float:right;">Logout</button>
            <h2>Tenant Submissions</h2>
            <div id="tenantList">Loading...</div>
            <h2 style="margin-top:2rem;">Approved Brokers</h2>
            <div id="approvedBrokers">Loading...</div>
            <h2 style="margin-top:2rem;">Pending Broker Requests</h2>
            <div id="brokerRequests">Loading...</div>
            <h2 style="margin-top:2rem;">Denied Broker Requests</h2>
            <div id="deniedBrokers">Loading...</div>
        </section>
    </main>
    <footer>
        <p>&copy; 2024 Retail Solutions. <a href="privacy.html">Privacy Policy</a></p>
    </footer>
    <script type="module">
        import { auth, db } from './app.js';
        import { 
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { 
            collection,
            query,
            orderBy,
            getDocs,
            doc,
            setDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        // Mock broker data (same as brokers.html)
        const brokers = [
            { name: "Jane Smith", city: "New York", zip: "10001", industries: ["Fashion", "Food", "Tech"], email: "jane.smith@brokerco.com" },
            { name: "Mike Johnson", city: "Los Angeles", zip: "90001", industries: ["Fitness", "Beauty", "Health"], email: "mike.johnson@brokerco.com" },
            { name: "Sara Lee", city: "Chicago", zip: "60601", industries: ["Food", "Retail"], email: "sara.lee@brokerco.com" },
            { name: "Carlos Martinez", city: "New York", zip: "10002", industries: ["Tech", "Services"], email: "carlos.martinez@brokerco.com" },
            { name: "Emily Chen", city: "San Francisco", zip: "94102", industries: ["Fashion", "Retail"], email: "emily.chen@brokerco.com" }
        ];

        // Auth and dashboard logic
        const loginSection = document.getElementById('loginSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('loginMessage');
        const tenantList = document.getElementById('tenantList');
        const logoutBtn = document.getElementById('logoutBtn');
        const brokerRequests = document.getElementById('brokerRequests');

        function showDashboard() {
            loginSection.style.display = 'none';
            dashboardSection.style.display = 'block';
            loadTenants();
            loadBrokerRequests();
            loadApprovedBrokers();
            loadDeniedBrokers();
        }
        function showLogin() {
            loginSection.style.display = 'block';
            dashboardSection.style.display = 'none';
        }

        // Listen for auth state
        onAuthStateChanged(auth, user => {
            if (user) {
                showDashboard();
            } else {
                showLogin();
            }
        });

        // Login form submit
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                loginMessage.textContent = 'Login failed: ' + err.message;
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async function() {
            await signOut(auth);
        });

        // Load tenants from Firestore
        async function loadTenants() {
            tenantList.textContent = 'Loading...';
            try {
                const q = query(collection(db, 'tenants'), orderBy('submittedAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    tenantList.innerHTML = '<p>No tenant submissions yet.</p>';
                    return;
                }
                tenantList.innerHTML = snapshot.docs.map(doc => {
                    const t = doc.data();
                    return `<div style="border-bottom:1px solid #eee; margin-bottom:1rem; padding-bottom:1rem;">
                        <strong>${t.businessName}</strong> (${t.industry})<br>
                        <strong>Location:</strong> ${t.city}, ${t.state} ${t.zip}<br>
                        <strong>Lease Status:</strong> ${t.leaseStatus}<br>
                        <strong>Size:</strong> ${t.size} sq ft<br>
                        <strong>Budget:</strong> ${t.budget || 'N/A'}<br>
                        <strong>Contact:</strong> ${t.contactName}, ${t.email}, ${t.phone}<br>
                        <small>Submitted: ${new Date(t.submittedAt).toLocaleString()}</small>
                    </div>`;
                }).join('');
            } catch (err) {
                tenantList.textContent = 'Error loading tenants: ' + err.message;
            }
        }

        // Load broker requests from Firestore
        async function loadBrokerRequests() {
            brokerRequests.textContent = 'Loading...';
            try {
                const q = query(collection(db, 'brokers_pending'), orderBy('submittedAt', 'desc'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    brokerRequests.innerHTML = '<p>No broker requests yet.</p>';
                    return;
                }
                brokerRequests.innerHTML = snapshot.docs.map(doc => {
                    const b = doc.data();
                    const id = doc.id;
                    return `<div style="border-bottom:1px solid #eee; margin-bottom:1rem; padding-bottom:1rem;">
                        <strong>${b.fullName}</strong> (${b.companyName})<br>
                        <strong>Email:</strong> ${b.email}<br>
                        <strong>Phone:</strong> ${b.phone}<br>
                        <strong>Office:</strong> ${b.officeCity}, ${b.officeState}<br>
                        <strong>Service Area:</strong> ${b.serviceArea}<br>
                        <strong>Industries:</strong> ${b.industries.join(', ')}<br>
                        <strong>License #:</strong> ${b.licenseNumber || 'N/A'}<br>
                        <strong>Bio:</strong> ${b.bio}<br>
                        <strong>Website:</strong> ${b.website || 'N/A'}<br>
                        <small>Submitted: ${new Date(b.submittedAt).toLocaleString()}</small><br>
                        <button class="cta-button" onclick="window.approveBroker('${id}')">Approve</button>
                        <button class="cta-button" onclick="window.rejectBroker('${id}')" style="background:#c0392b;">Reject</button>
                    </div>`;
                }).join('');
            } catch (err) {
                brokerRequests.textContent = 'Error loading broker requests: ' + err.message;
            }
        }

        // Approve broker
        window.approveBroker = async function(id) {
            try {
                const docRef = doc(db, 'brokers_pending', id);
                const docSnap = await getDocs(query(collection(db, 'brokers_pending')));
                let brokerData;
                docSnap.forEach(d => { if (d.id === id) brokerData = d.data(); });
                if (!brokerData) throw new Error('Broker not found');
                await setDoc(doc(db, 'brokers', id), brokerData);
                await deleteDoc(docRef);
                loadBrokerRequests();
            } catch (err) {
                alert('Error approving broker: ' + err.message);
            }
        }

        // Reject broker
        window.rejectBroker = async function(id) {
            try {
                const docRef = doc(db, 'brokers_pending', id);
                const docSnap = await getDocs(query(collection(db, 'brokers_pending')));
                let brokerData;
                docSnap.forEach(d => { if (d.id === id) brokerData = d.data(); });
                if (!brokerData) throw new Error('Broker not found');
                await setDoc(doc(db, 'rejected_brokers', id), brokerData);
                await deleteDoc(docRef);
                loadBrokerRequests();
            } catch (err) {
                alert('Error rejecting broker: ' + err.message);
            }
        }

        // Load approved brokers from Firestore
        async function loadApprovedBrokers() {
            const approvedBrokers = document.getElementById('approvedBrokers');
            approvedBrokers.textContent = 'Loading...';
            try {
                const q = query(collection(db, 'brokers'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    approvedBrokers.innerHTML = '<p>No approved brokers yet.</p>';
                    return;
                }
                approvedBrokers.innerHTML = snapshot.docs.map(doc => {
                    const b = doc.data();
                    return `<div style=\"border-bottom:1px solid #eee; margin-bottom:1rem; padding-bottom:1rem;\">
                        <strong>${b.fullName}</strong> (${b.companyName})<br>
                        <strong>Email:</strong> ${b.email}<br>
                        <strong>Phone:</strong> ${b.phone}<br>
                        <strong>Office:</strong> ${b.officeCity}, ${b.officeState}<br>
                        <strong>Service Area:</strong> ${b.serviceArea}<br>
                        <strong>Industries:</strong> ${b.industries ? b.industries.join(', ') : ''}<br>
                        <strong>License #:</strong> ${b.licenseNumber || 'N/A'}<br>
                        <strong>Bio:</strong> ${b.bio || 'N/A'}<br>
                        <strong>Website:</strong> ${b.website || 'N/A'}<br>
                        <small>Approved: ${b.submittedAt ? new Date(b.submittedAt).toLocaleString() : ''}</small>
                    </div>`;
                }).join('');
            } catch (err) {
                approvedBrokers.textContent = 'Error loading approved brokers: ' + err.message;
            }
        }

        // Load denied brokers from Firestore
        async function loadDeniedBrokers() {
            const deniedBrokers = document.getElementById('deniedBrokers');
            deniedBrokers.textContent = 'Loading...';
            try {
                const q = query(collection(db, 'rejected_brokers'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    deniedBrokers.innerHTML = '<p>No denied broker requests.</p>';
                    return;
                }
                deniedBrokers.innerHTML = snapshot.docs.map(doc => {
                    const b = doc.data();
                    return `<div style=\"border-bottom:1px solid #eee; margin-bottom:1rem; padding-bottom:1rem;\">
                        <strong>${b.fullName}</strong> (${b.companyName})<br>
                        <strong>Email:</strong> ${b.email}<br>
                        <strong>Phone:</strong> ${b.phone}<br>
                        <strong>Office:</strong> ${b.officeCity}, ${b.officeState}<br>
                        <strong>Service Area:</strong> ${b.serviceArea}<br>
                        <strong>Industries:</strong> ${b.industries ? b.industries.join(', ') : ''}<br>
                        <strong>License #:</strong> ${b.licenseNumber || 'N/A'}<br>
                        <strong>Bio:</strong> ${b.bio || 'N/A'}<br>
                        <strong>Website:</strong> ${b.website || 'N/A'}<br>
                        <small>Denied: ${b.submittedAt ? new Date(b.submittedAt).toLocaleString() : ''}</small>
                    </div>`;
                }).join('');
            } catch (err) {
                deniedBrokers.textContent = 'Error loading denied brokers: ' + err.message;
            }
        }

        document.getElementById('joinBrokerBtn').onclick = function() {
            window.location.href = 'broker_request.html';
        };
    </script>
</body>
</html> 